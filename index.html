<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tomato Manga Zone</title>

<style>
/* CSS styles - Original Design Maintained */
*{margin:0;padding:0;box-sizing:border-box}
:root{ --bg:#000; --text:#fff; --card:#111; --accent:#ff2a2a; }
body.light{ --bg:#fff; --text:#000; --card:#f2f2f2; --accent:#ff2a2a; }
html,body{ width:100%; min-height:100%; background:var(--bg); color:var(--text); font-family:Arial,sans-serif; transition:.35s; }
#intro{ position:fixed; inset:0; background:black; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:3000; transition:.6s; overflow:hidden; }
#intro.fade-out{opacity:0}
#intro h1{color:red;font-size:30px;z-index:2}
#intro p{opacity:.8;z-index:2}
#intro button{ margin-top:25px; padding:12px 30px; border:none; border-radius:25px; background:red; color:white; cursor:pointer; z-index:2; }
#introBg{ position:absolute; inset:-40%; display:grid; grid-template-columns:repeat(auto-fill,160px); gap:18px; opacity:.8; filter:grayscale(35%); animation:introMove 90s linear infinite; z-index:1; }
#introBg svg{width:160px;height:220px;border-radius:6px}
@keyframes introMove{ from{transform:translate(0,0)} to{transform:translate(-600px,-500px)} }
#mainHeader{ position:sticky; top:0; z-index:2000; background:linear-gradient(180deg,#111,#000); box-shadow:0 6px 18px rgba(0,0,0,.7); }
body.light #mainHeader{background:linear-gradient(180deg,#fff,#eee)}
#headerInner{ height:64px; display:flex; align-items:center; padding:0 14px; }
#headerLeft{width:170px}
.searchWrap{ display:flex; align-items:center; gap:6px; padding:6px 12px; background:var(--card); border-radius:20px; }
.searchWrap input{ width:100px; background:none; border:none; outline:none; color:var(--text); font-size:13px; }
#headerCenter{ flex:1; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.1; }
.logo-top { font-size: 13px; font-weight: 400; color: var(--text); letter-spacing: 3px; text-transform: uppercase; }
.logo-bottom { font-size: 15px; font-weight: 900; color: var(--accent); letter-spacing: 1px; text-transform: uppercase; }
#headerRight{width:120px;display:flex;justify-content:flex-end;gap:8px}
.iconBtn{ width:40px;height:40px;border-radius:50%;background:var(--card); display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer; }
#headerLine{height:3px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}
#showcase{width:100%;aspect-ratio:14/7;max-height:280px;overflow:hidden;position:relative;background:#000;display:none}
#showcaseTrack{display:flex;height:100%;transition:transform 1s ease}
.showcaseItem{min-width:100%;height:100%}
.showcaseItem img{width:100%;height:100%;object-fit:cover}
#popularTitleBar { padding: 20px 15px 10px; display: none; align-items: center; gap: 12px; }
.pop-text { font-size: 16px; font-weight: 800; color: var(--accent); text-transform: uppercase; letter-spacing: 1.5px; white-space: nowrap; }
.pop-line { height: 2px; flex: 1; background: linear-gradient(90deg, var(--accent), transparent); border-radius: 2px; }
#featuredBar{width:100%;padding:14px 12px;overflow-x:auto;border-bottom:1px solid #222;display:none}
#featuredTrack{display:flex;gap:14px}
.featuredItem img{width:130px;height:180px;object-fit:cover;border-radius:8px}
#adminSidebar{ position:fixed;top:0;right:-320px;width:320px;height:100%; background:#111;padding:15px;transition:.4s;z-index:2500;overflow-y:auto; }
#adminSidebar.show{right:0}
#adminSidebar input,#adminSidebar button,#adminSidebar select{ width:100%;margin:6px 0 12px;padding:12px;background:#222;color:white;border:none;border-radius:6px; }
#adminBack{position:sticky;bottom:0;padding:10px;background:#1a1a1a;text-align:center;cursor:pointer}
.upload-zone { border: 2px dashed #444; padding: 20px; text-align: center; border-radius: 8px; margin: 10px 0; background: #1a1a1a; color: #888; cursor: pointer; transition: .3s; }
.upload-zone:active { border-color: var(--accent); background: #222; }
.upload-zone b { color: var(--accent); display: block; margin-bottom: 5px; }
#previewGrid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; margin-bottom: 15px; }
.pre-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 4px; border: 1px solid #333; }
#mangaList{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:15px;padding:20px}
.manga img{width:100%;aspect-ratio:3/4;object-fit:cover;border-radius:6px}
.manga p{text-align:center;font-size:13px;margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#detailPage{display:none;padding:15px}
.backBtn{background:#333;color:white;padding:8px;margin-bottom:15px;border-radius:4px;cursor:pointer;border:none}
#chapterList img{width:100%;display:block;margin-bottom:2px}
#uploadStatus{position:fixed;bottom:20px;right:20px;padding:7px 14px;font-size:13px;border-radius:6px;background:#111;opacity:0;transition:.3s;z-index:4000}
#uploadStatus.show{opacity:1}
#uploadStatus.success{border:1px solid #0f0;color:#0f0}
#uploadStatus.fail{border:1px solid #f00;color:#f00}
#historyList{max-height:200px;overflow-y:auto}
.historyItem{display:flex;align-items:center;gap:10px;padding:6px;margin-bottom:6px;background:#1a1a1a;border-radius:6px}
.historyItem img{width:45px;height:60px;object-fit:cover;border-radius:4px}
.historyInfo{flex:1;font-size:12px;overflow:hidden}
</style>
</head>

<body>

<div id="intro">
  <div id="introBg"></div>
  <h1>Tomato Manga Zone</h1>
  <p>Manga Online Read</p>
  <button onclick="enterSite()">ENTER</button>
</div>

<div id="mainHeader" style="display:none">
  <div id="headerInner">
    <div id="headerLeft"><div class="searchWrap">üîç <input placeholder="Search..."></div></div>
    <div id="headerCenter">
      <span class="logo-top">Tomato</span>
      <span class="logo-bottom">Manga Zone</span>
    </div>
    <div id="headerRight">
      <div class="iconBtn" id="themeBtn">üåô</div>
      <div class="iconBtn" onclick="toggleAdmin()">‚ò∞</div>
    </div>
  </div>
  <div id="headerLine"></div>
</div>

<div id="showcase"><div id="showcaseTrack"></div></div>

<div id="popularTitleBar">
  <span class="pop-text">Popular Manga</span>
  <div class="pop-line"></div>
</div>

<div id="featuredBar"><div id="featuredTrack"></div></div>

<div id="adminSidebar">
  <div id="loginBox">
    <label>Admin Password</label>
    <input type="password" id="adminPass">
    <button onclick="checkPass()">Login</button>
  </div>

  <div id="adminForm" style="display:none">
    <h3 style="color: #0f0;">Step 1: Create Manga</h3>
    <input id="mangaTitle" placeholder="Manga Title">
    <label>Cover Image</label>
    <input type="file" id="mangaImg" accept="image/*">
    <button onclick="uploadManga()" id="createBtn" style="background: #2255ff;">Create Manga</button>

    <hr style="margin: 20px 0; border: 0.5px solid #333;">

    <h3 style="color: #ff9900;">Step 2: Add Chapter</h3>
    <select id="mangaSelect"></select>
    <input id="chapterTitle" placeholder="Chapter Title (e.g. Ch 01)">
    
    <div class="upload-zone" onclick="document.getElementById('chapterFiles').click()">
      <b>üìÅ SELECT MULTIPLE IMAGES</b>
      <span id="fileStatus">Cloud Storage Integration (ImgBB)</span>
    </div>
    <input type="file" id="chapterFiles" accept="image/*" multiple onchange="handleFiles(this.files)" style="display:none">
    
    <div id="previewGrid"></div>

    <button onclick="uploadChapter()" id="uploadBtn" style="background: #ff2a2a;">Upload Chapter</button>

    <h3>Manage</h3>
    <div id="historyList"></div>
  </div>
  <div id="adminBack" onclick="toggleAdmin()">‚Üê Back</div>
</div>

<div id="mangaList"></div>

<div id="detailPage">
  <button class="backBtn" onclick="closeDetail()">‚Üê Back</button>
  <h2 id="detailName" style="margin-bottom:10px;"></h2>
  <div id="chapterList"></div>
</div>

<div id="uploadStatus"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // IMGBB CONFIGURATION
  const IMGBB_API_KEY = "1514f8313ed6947ee69bcdec03b70517";

  const firebaseConfig = {
    apiKey: "AIzaSyBBr71Dk5pFn8UkIn5DOoBYeQWPvFcKX4", 
    authDomain: "tomato-manga-zone.firebaseapp.com",
    projectId: "tomato-manga-zone",
    storageBucket: "tomato-manga-zone.firebasestorage.app",
    messagingSenderId: "28164821885",
    appId: "1:28164821885:web:d23cc3faa8d8dbae22f214",
    measurementId: "G-BNR7BQP2VC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.mangas = [];
  
  // Helper: Cloud Upload Function
  async function uploadToCloud(file) {
      let formData = new FormData();
      formData.append("image", file);
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
          method: "POST",
          body: formData
      });
      const data = await res.json();
      if(!data.success) throw new Error("Cloud Upload Failed");
      return data.data.url; // Returns the clean URL string
  }

  // Intro background logic
  const introBg = document.getElementById('introBg');
  for(let i=0;i<42;i++){
    introBg.innerHTML+=`<svg viewBox="0 0 160 220"><rect width="160" height="220" fill="#222"/><rect x="10" y="10" width="140" height="60" fill="#000"/><rect x="10" y="80" width="60" height="50" fill="#000"/><rect x="80" y="80" width="70" height="120" fill="#000"/></svg>`;
  }

  window.handleFiles = function(files) {
    const status = document.getElementById('fileStatus');
    status.innerText = files.length + " images selected. Ready to upload.";
  }

  onSnapshot(collection(db, "mangas"), (snapshot) => {
    window.mangas = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
    renderPublic(); renderFeatured(); renderShowcase(); renderHistory(); updateMangaSelect();
  });

  window.uploadManga = async function() {
    const title = document.getElementById('mangaTitle').value;
    const imgInput = document.getElementById('mangaImg');
    const btn = document.getElementById('createBtn');

    if(!title || !imgInput.files[0]) {
      showStatus("Title & Cover required","fail"); return;
    }

    btn.disabled = true;
    showStatus("Uploading Cover to ImgBB...", "success");
    
    try {
      const imageUrl = await uploadToCloud(imgInput.files[0]);
      await addDoc(collection(db, "mangas"), {
        id: Date.now(),
        name: title,
        img: imageUrl,
        chapters: []
      });
      document.getElementById('mangaTitle').value = "";
      imgInput.value = "";
      showStatus("Manga Created! ‚ú®","success");
    } catch(e) { 
      showStatus("Cloud Error! Check Internet.","fail"); 
    }
    btn.disabled = false;
  }

  window.uploadChapter = async function() {
    const selectedFbId = document.getElementById('mangaSelect').value;
    const cTitle = document.getElementById('chapterTitle').value;
    const files = document.getElementById('chapterFiles').files;
    const btn = document.getElementById('uploadBtn');

    if(!selectedFbId || !cTitle || files.length === 0){
      showStatus("Data missing","fail"); return;
    }

    btn.disabled = true;
    showStatus(`Uploading ${files.length} pages... (Please wait)`, "success");

    try {
      let cloudUrls = [];
      for(let file of files) {
          const url = await uploadToCloud(file);
          cloudUrls.push(url);
      }

      const targetManga = window.mangas.find(m => m.fbId === selectedFbId);
      const updatedChapters = [...(targetManga.chapters || []), { title: cTitle, pages: cloudUrls }];
      
      await updateDoc(doc(db, "mangas", selectedFbId), {
        chapters: updatedChapters
      });

      document.getElementById('chapterTitle').value = "";
      document.getElementById('fileStatus').innerText = "Cloud Storage Integration (ImgBB)";
      showStatus("Chapter Uploaded! üéâ","success");
    } catch(e) { showStatus("Upload Failed!","fail"); }
    btn.disabled = false;
  }

  window.deleteManga = async function(fbId) {
    if(confirm("Confirm delete from Database?")) {
      try {
        await deleteDoc(doc(db, "mangas", fbId));
        showStatus("Deleted","success");
      } catch(e) { showStatus("Error deleting","fail"); }
    }
  }

  window.enterSite = () => {
    document.getElementById('intro').classList.add("fade-out");
    setTimeout(() => { 
      document.getElementById('intro').style.display="none"; 
      document.getElementById('mainHeader').style.display="block"; 
    }, 600);
  }

  document.getElementById('themeBtn').onclick = () => {
    document.body.classList.toggle("light");
    document.getElementById('themeBtn').innerText = document.body.classList.contains("light") ? "üåû" : "üåô";
  }

  window.toggleAdmin = () => document.getElementById('adminSidebar').classList.toggle("show");

  window.checkPass = () => {
    if(document.getElementById('adminPass').value === "Tomatochitsanmg03"){
      document.getElementById('loginBox').style.display="none"; 
      document.getElementById('adminForm').style.display="block";
      showStatus("Welcome Admin","success");
    } else showStatus("Access Denied","fail");
  }

  function showStatus(t,type){
    const s = document.getElementById('uploadStatus');
    s.innerText=t; s.className=type+" show";
    setTimeout(()=>s.className="",3000);
  }

  function updateMangaSelect(){
    document.getElementById('mangaSelect').innerHTML = window.mangas.map(m => `<option value="${m.fbId}">${m.name}</option>`).join('');
  }

  function renderPublic(){
    document.getElementById('mangaList').innerHTML = window.mangas.map(m => `
      <div class="manga" onclick="openManga('${m.fbId}')">
        <img src="${m.img}">
        <p>${m.name}</p>
      </div>`).join('');
  }

  function renderFeatured(){
    const bar = document.getElementById('featuredBar');
    const title = document.getElementById('popularTitleBar');
    if(window.mangas.length > 0) { bar.style.display="block"; title.style.display="flex"; }
    else { bar.style.display="none"; title.style.display="none"; }
    document.getElementById('featuredTrack').innerHTML = window.mangas.map(m => `<div class="featuredItem" onclick="openManga('${m.fbId}')"><img src="${m.img}"></div>`).join('');
  }

  function renderShowcase(){
    const sc = document.getElementById('showcase');
    if(window.mangas.length > 0) sc.style.display="block";
    else sc.style.display="none";
    document.getElementById('showcaseTrack').innerHTML = window.mangas.map(m => `<div class="showcaseItem"><img src="${m.img}"></div>`).join('');
  }

  function renderHistory(){
    document.getElementById('historyList').innerHTML = window.mangas.map(m => `
      <div class="historyItem">
        <img src="${m.img}">
        <div class="historyInfo"><b>${m.name}</b><br>${(m.chapters || []).length} Chaps</div>
        <div style="color:red; cursor:pointer;" onclick="deleteManga('${m.fbId}')">üóëÔ∏è</div>
      </div>`).join('');
  }

  window.openManga = function(fbId){
    const m = window.mangas.find(x => x.fbId === fbId);
    document.getElementById('mangaList').style.display = "none"; 
    document.getElementById('showcase').style.display = "none"; 
    document.getElementById('featuredBar').style.display = "none";
    document.getElementById('popularTitleBar').style.display = "none";
    document.getElementById('detailPage').style.display = "block";
    document.getElementById('detailName').innerText = m.name;
    
    let html = "";
    if(!m.chapters || m.chapters.length === 0) html = "<p style='text-align:center; opacity:0.5;'>No Chapters Yet</p>";
    else {
      m.chapters.forEach(ch => {
        html += `<h3 style="margin:20px 0 10px; color:red; padding-left:10px;">${ch.title}</h3>`;
        ch.pages.forEach(p => { html += `<img src="${p}" style="width:100%; display:block; margin-bottom:2px;">`; });
      });
    }
    document.getElementById('chapterList').innerHTML = html;
    window.scrollTo(0,0);
  }

  window.closeDetail = function(){
    document.getElementById('detailPage').style.display = "none"; 
    document.getElementById('mangaList').style.display = "grid";
    if(window.mangas.length > 0){ 
      document.getElementById('showcase').style.display="block"; 
      document.getElementById('featuredBar').style.display="block"; 
      document.getElementById('popularTitleBar').style.display="flex"; 
    }
  }
</script>
</body>
</html>
