<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tomato Manga Zone</title>

<style>
/* CSS styles - Premium Animation & Speed Fixes */
*{margin:0;padding:0;box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
:root{ --bg:#000; --text:#fff; --card:#111; --accent:#ff2a2a; --glass: rgba(255, 255, 255, 0.08); --flare: rgba(255, 42, 42, 0.4); }
body.light{ --bg:#fff; --text:#000; --card:#f2f2f2; --accent:#ff2a2a; --glass: rgba(0, 0, 0, 0.05); --flare: rgba(255, 42, 42, 0.2); }

/* --- REFRESH DISABLE FIX --- */
html, body { 
  width:100%; 
  height:100%; 
  background:var(--bg); 
  color:var(--text); 
  font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
  transition:.35s; 
  scroll-behavior: auto !important; 
  overflow: hidden; 
  overscroll-behavior-y: contain; 
}

/* App Containers */
.app-lobby {
  height: 100vh;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
}

/* Performance Boost */
#mangaList, #featuredBar, #chapterList, #bookmarkList {
  content-visibility: auto;
  contain-intrinsic-size: 500px;
}

/* --- PREMIUM CINEMATIC ANIMATIONS --- */
@keyframes lobbyEntrance {
  0% { opacity: 0; transform: scale(0.95) translateY(30px); filter: blur(10px); }
  100% { opacity: 1; transform: scale(1) translateY(0); filter: blur(0px); }
}

@keyframes lobbyExit {
  0% { opacity: 1; transform: scale(1) translateY(0); }
  100% { opacity: 0; transform: scale(1.05) translateY(-30px); filter: blur(10px); }
}

@keyframes mangaSlideUp {
  0% { opacity: 0; transform: translateY(40px); }
  100% { opacity: 1; transform: translateY(0); }
}

@keyframes doorOpen {
  from { transform: scale(1); opacity: 1; }
  to { transform: scale(1.5); opacity: 0; filter: blur(10px); }
}

@keyframes pulseRed {
  0% { box-shadow: 0 0 0 0 rgba(255, 42, 42, 0.4); }
  70% { box-shadow: 0 0 0 15px rgba(255, 42, 42, 0); }
  100% { box-shadow: 0 0 0 0 rgba(255, 42, 42, 0); }
}

@keyframes shimmer {
  0% { background-position: -468px 0; }
  100% { background-position: 468px 0; }
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* NEW: PREMIUM GLOW ANIMATION FOR NEW CHAPTER */
@keyframes newBadgeGlow {
  from { opacity: 0.6; box-shadow: 0 0 5px var(--accent); }
  to { opacity: 1; box-shadow: 0 0 15px var(--accent); }
}

.new-chapter-badge {
    position: absolute;
    top: 6px;
    right: 6px;
    background: var(--accent);
    color: #fff;
    font-size: 8px;
    font-weight: 900;
    padding: 3px 6px;
    border-radius: 4px;
    text-transform: uppercase;
    z-index: 5;
    animation: newBadgeGlow 1.2s infinite alternate;
    letter-spacing: 0.5px;
    pointer-events: none;
}

/* CODE ·Ä°·Äû·ÄÖ·Ä∫: PREMIUM COVER BADGE (Bottom Left Inside) */
.premium-cover-badge {
    position: absolute;
    bottom: 45px; 
    left: 8px;
    background: rgba(0, 0, 0, 0.65);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    color: #fff;
    font-size: 9px;
    font-weight: 800;
    padding: 3px 10px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 1px;
    z-index: 5;
    border: 0.5px solid rgba(255, 255, 255, 0.2);
    pointer-events: none;
    display: flex;
    align-items: center;
    gap: 4px;
}
.premium-cover-badge::before {
    content: '';
    width: 5px;
    height: 5px;
    background: #ff2a2a;
    border-radius: 50%;
    display: inline-block;
}

/* --- NEW PREMIUM WAVE ANIMATION --- */
.wave-container {
  width: 100%;
  height: 40px;
  position: relative;
  overflow: hidden;
  margin: 10px 0;
}
.wave {
  position: absolute;
  width: 200%;
  height: 100%;
  background-repeat: repeat-x;
  background-position: 0 bottom;
  transform-origin: center bottom;
}
.wave1 {
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V46.29C41.3,56.44,95.7,69.18,153.3,64.38,210.9,59.58,252,69.18,321.39,56.44Z" fill="%23ff2a2a" opacity="0.6"></path></svg>');
  animation: moveWave 10s linear infinite;
  z-index: 2;
  opacity: 0.5;
}
.wave2 {
  background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V46.29C41.3,56.44,95.7,69.18,153.3,64.38,210.9,59.58,252,69.18,321.39,56.44Z" fill="%23ff2a2a" opacity="1"></path></svg>');
  animation: moveWave 15s linear infinite;
  z-index: 1;
  bottom: 2px;
}
@keyframes moveWave {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}

.skeleton {
  background: #222;
  background-image: linear-gradient(to right, #222 0%, #333 20%, #222 40%, #222 100%);
  background-repeat: no-repeat;
  background-size: 800px 104px;
  animation: shimmer 1.5s linear infinite forwards;
  border-radius: 10px;
}

/* --- NEW: IMAGE PLACEHOLDER & SKELETON --- */
.page-placeholder {
    width: 100%;
    aspect-ratio: 2 / 3;
    background-color: #111;
    position: relative;
    overflow: hidden;
    margin-bottom: 2px;
}
.page-placeholder::after {
    content: "";
    position: absolute;
    inset: 0;
    background-image: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.05) 50%, transparent 100%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}

#intro { 
  position:fixed; inset:0; background:black; display:flex; 
  flex-direction:column; justify-content:center; align-items:center; 
  z-index:3000; transition: 0.8s cubic-bezier(0.85, 0, 0.15, 1); 
  overflow:hidden; 
}
#intro.fade-out { animation: doorOpen 0.8s forwards; pointer-events: none; }

#intro h1 { color:red; font-size:35px; z-index:2; letter-spacing: 2px; text-shadow: 0 0 20px rgba(255,0,0,0.5); }
#intro p { opacity:.6; z-index:2; letter-spacing: 5px; text-transform: uppercase; font-size: 12px; margin-top: 5px; }
#intro button { 
  margin-top:40px; padding:15px 45px; border:none; border-radius:30px; 
  background:red; color:white; cursor:pointer; z-index:2; font-weight: bold;
  letter-spacing: 2px; transition: 0.3s; animation: pulseRed 2s infinite;
}

#introBg{ position:absolute; inset:-40%; display:grid; grid-template-columns:repeat(auto-fill,160px); gap:18px; opacity:.3; filter:grayscale(100%); animation:introMove 90s linear infinite; z-index:1; }
#introBg svg{width:160px;height:220px;border-radius:6px}
@keyframes introMove{ from{transform:translate(0,0)} to{transform:translate(-600px,-500px)} }

#mainContentWrapper { display: none; opacity: 0; }
#mainContentWrapper.animate-in { display: block; animation: lobbyEntrance 1s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

#mainHeader { 
  position:sticky; top:0; z-index:2000; 
  background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

#headerInner{ height:80px; display:flex; align-items:center; padding:0 18px; justify-content: space-between; overflow: visible; position: relative;}

/* --- UPDATED SEARCH CONTAINER --- */
#searchContainer {
  position: absolute; left: 18px; right: 80px; height: 50px;
  background: var(--card); border-radius: 15px; border: 1px solid var(--accent);
  display: flex; align-items: center; padding: 0 15px;
  transform: translateX(-120%); transition: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  z-index: 10;
}
#searchContainer.active { transform: translateX(0); }
#searchContainer input {
  flex: 1; background: none; border: none; outline: none;
  color: var(--text); font-size: 15px; font-weight: 500;
}
.searchClose { color: var(--accent); font-weight: 900; cursor: pointer; padding: 5px; font-size: 20px;}

/* PREMIUM SEARCH DROPDOWN LIST */
#searchDropdown {
    position: absolute;
    top: calc(100% + 5px);
    left: 0;
    width: 100%;
    background: #111;
    border-radius: 12px;
    border: 1px solid rgba(255, 42, 42, 0.3);
    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    display: none;
    flex-direction: column;
    max-height: 350px;
    overflow-y: auto;
    z-index: 1000;
}

.search-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    transition: 0.2s;
}

.search-item:hover {
    background: rgba(255, 42, 42, 0.1);
}

.search-item img {
    width: 45px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
    margin-right: 12px;
}

.search-item-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.search-item-title {
    font-size: 14px;
    font-weight: 700;
    color: #fff;
}

.search-item-meta {
    font-size: 11px;
    color: #888;
}

#headerCenter { 
  text-align: center; transition: 0.4s; flex: 1;
}
#headerCenter.hide { opacity: 0; transform: scale(0.8); pointer-events: none;}
.logo-main {
  font-size: 18px; font-weight: 900; letter-spacing: 1px;
  text-transform: uppercase; display: block;
}
.logo-main .t-red { color: var(--accent); text-shadow: 0 0 10px rgba(255,0,0,0.3); }
.logo-sub {
  font-size: 11px; font-weight: 400; letter-spacing: 6px; 
  opacity: 0.6; text-transform: uppercase; margin-top: -1px; display: block;
}

#headerRight{ display:flex; align-items:center; gap:12px; }

.iconBtn { 
  width:45px; height:45px; border-radius:14px; 
  background:rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
  display:flex; align-items:center; justify-content:center; 
  cursor:pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.iconBtn svg { width: 22px; height: 22px; fill: var(--text); transition: 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
.iconBtn:active { transform: scale(0.9); background: rgba(255,255,255,0.1); } 

.rotate-anim { transform: rotate(360deg); }

#showcase{ width:95%; margin: 15px auto; border-radius: 15px; aspect-ratio:14/7; max-height:300px; overflow:hidden; position:relative; background:#000; display:none; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
#showcaseTrack{display:flex;height:100%;transition:transform 0.8s cubic-bezier(0.65, 0, 0.35, 1)}
.showcaseItem{min-width:100%;height:100%}
.showcaseItem img{width:100%;height:100%;object-fit:cover}

#popularTitleBar { padding: 25px 20px 10px; display: none; align-items: center; gap: 15px; }
.pop-text { font-size: 18px; font-weight: 800; color: var(--text); text-transform: uppercase; letter-spacing: 2px; }
.pop-line { height: 3px; flex: 1; background: linear-gradient(90deg, var(--accent), transparent); border-radius: 3px; }

#featuredBar {
  width: 96%; margin: 10px auto 10px; padding: 30px 0;
  overflow: hidden; display: none;
  background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  box-shadow: inset 0 0 25px 2px rgba(255, 255, 255, 0.15), 0 10px 30px rgba(0,0,0,0.6);
  position: relative; cursor: grab; user-select: none;
}
#featuredBar:active { cursor: grabbing; }
#featuredTrack { display: flex; gap: 18px; padding: 0 25px; width: max-content; will-change: transform; }
.featuredItem img { 
  width: 145px; height: 205px; object-fit: cover; border-radius: 4px; 
  transition: transform 0.3s; box-shadow: 0 8px 20px rgba(0,0,0,0.8);
  border: 1px solid rgba(255,255,255,0.1); pointer-events: none;
}
.featuredItem:hover img { transform: scale(1.05); }

.premium-divider {
  width: 96%; height: 4px; margin: 0 auto 25px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
  border-radius: 10px; box-shadow: 0 4px 15px rgba(255, 42, 42, 0.5);
  display: none; 
}

/* --- NEW PREMIUM TITLE STYLE --- */
.manga-list-header {
  padding: 30px 25px 5px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.manga-list-header h2 {
  font-size: 18px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: var(--text);
}
.manga-list-header .accent-bar {
  width: 5px;
  height: 20px;
  background: var(--accent);
  border-radius: 10px;
  box-shadow: 0 0 10px var(--accent);
}

#mangaList{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:20px;padding:25px;}

.manga { 
  position: relative; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.4s ease;
  cursor: pointer; z-index: 1;
}
.manga.animate {
  animation: mangaSlideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) backwards;
}

.manga:hover, .manga:active { transform: translateY(-12px) scale(1.08); z-index: 10; }
.manga::before {
  content: ''; position: absolute; inset: 0; background: var(--flare);
  filter: blur(25px); border-radius: 12px; opacity: 0; transition: opacity 0.4s ease; z-index: -1;
}
.manga:hover::before, .manga:active::before { opacity: 1; }
.manga img{width:100%;aspect-ratio:3/4;object-fit:cover;border-radius:10px; box-shadow: 0 8px 15px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; background: #1a1a1a;}
.manga p{text-align:center;font-size:14px;font-weight:600;margin-top:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap; opacity: 0.9;}

#detailPage{display:none; padding: 0; width: 100%; background: var(--bg); position: absolute; top: 0; left: 0; z-index: 5000; min-height: 100vh;}

.lobby-container {
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 15px;
  animation: fadeInUp 0.4s ease-out;
}

.lobby-top {
  display: flex;
  gap: 15px;
  align-items: flex-start;
}

.lobby-left {
  flex: 0 0 130px; 
  display: flex;
  flex-direction: column;
  align-items: center;
}

.lobby-left img {
  width: 100%;
  border-radius: 10px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(255,255,255,0.1);
  display: block;
}

.lobby-right {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding-top: 5px;
}

.bookmark-toggle-btn {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--accent);
  color: var(--accent);
  background: rgba(255,42,42,0.05);
  font-weight: 800;
  font-size: 11px;
  cursor: pointer;
  width: 100%;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: 0.3s;
}
.bookmark-toggle-btn.active { background: var(--accent); color: white; }

.manga-rating { color: #ffcc00; font-size: 16px; font-weight: 900; display: flex; align-items: center; gap: 5px; }

.manga-genres { display: flex; flex-wrap: wrap; gap: 6px; }

.genre-tag {
  background: var(--glass);
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 10px;
  font-weight: 700;
  border: 1px solid rgba(255,255,255,0.1);
  text-transform: uppercase;
}

.manga-title-wrap { margin-top: 10px; display: flex; flex-direction: column; align-items: flex-start; }

.manga-title {
  width: 130px; 
  font-size: 15px; 
  font-weight: 900;
  line-height: 1.2;
  letter-spacing: 0.5px;
  font-family: 'Garamond', 'Georgia', serif;
  color: var(--text);
  margin-top: 10px;
  text-align: center;
  word-wrap: break-word;
}

.manga-description {
    width: 100%;
    font-size: 13px;
    line-height: 1.6;
    opacity: 0.7;
    padding: 12px;
    background: rgba(255,255,255,0.03);
    border-radius: 10px;
    border-left: 3px solid var(--accent);
    color: #ddd;
    text-align: left;
    margin-top: 15px;
}

.backBtn{background:var(--card);color:white;padding:12px 20px;margin: 20px;border-radius:30px;cursor:pointer;border:1px solid rgba(255,255,255,0.1); font-weight: bold; transition: 0.3s; display: inline-block;}

/* --- CHAPTER LIST SECTION --- */
.chapter-list-section {
    margin-top: 20px;
    padding: 0 20px 40px;
}
.chapter-list-header {
    font-size: 22px;
    font-weight: 900;
    color: var(--text);
    margin-bottom: 20px;
    letter-spacing: 1px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 10px;
}
.chapter-item {
    background: var(--card);
    padding: 15px 20px;
    border-radius: 12px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
    transition: 0.3s;
    position: relative;
}
.chapter-item.read { opacity: 0.5; border: 1px solid var(--accent); }
.chapter-item:active { transform: scale(0.97); background: var(--accent); }
.chapter-item span { font-weight: 700; font-size: 15px; }

.view-count {
  font-size: 12px;
  opacity: 0.8;
  display: flex;
  align-items: center; gap: 5px;
  position: absolute; bottom: 8px; right: 20px;
}

#pagesContainer img {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: high-quality;
    -ms-interpolation-mode: bicubic;
    transform: translateZ(0);
    will-change: transform;
    filter: sharpness(1.05);
    width: 100%; 
    display: block; 
    height: auto;
    pointer-events: none; /* Security fix */
    user-select: none;
}

#readingLobby {
    display: none;
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 6000;
}

#pagesContainer { 
    display: flex; 
    flex-direction: column; 
    width: 100%; 
    will-change: transform;
    transition: margin-top 0.3s ease; /* Head bar hide animation smooth ·Äñ·Äº·ÄÖ·Ä∫·Äñ·Ä≠·ÄØ·Ä∑ */
}

#readingLobby.page-mode #pagesContainer {
    flex-direction: row;
    height: 100vh;
    transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    margin-top: 0 !important; /* Page mode ·Äô·Äæ·Ä¨ margin ·Äô·Äú·Ä≠·ÄØ·Äò·Ä∞·Ä∏ */
}
#readingLobby.page-mode .page-item {
    min-width: 100vw;
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
    flex-shrink: 0;
    overflow: hidden;
}
#readingLobby.page-mode .page-item img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    display: block;
}

.reading-header {
    position: fixed; top: 0; width: 100%; background: rgba(0,0,0,0.8);
    backdrop-filter: blur(10px); padding: 15px; z-index: 6100;
    display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1);
    transition: transform 0.3s ease; /* Slide animation */
}
/* Head bar ·Äï·Äª·Ä±·Ä¨·ÄÄ·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äê·Ä≤·Ä∑·Ä°·ÄÅ·Ä´·Äû·ÄØ·Ä∂·Ä∏·Äô·Äö·Ä∑·Ä∫ class */
.reading-header.hidden {
    transform: translateY(-100%);
}

.reading-nav-panel {
    display: flex;
    justify-content: space-between;
    padding: 20px;
    background: #111;
    border-top: 1px solid rgba(255,255,255,0.1);
    margin-top: 20px;
}
#readingLobby.page-mode .reading-nav-panel { display: none; } 

.nav-btn {
    padding: 12px 25px;
    border-radius: 8px;
    background: var(--accent);
    color: white;
    font-weight: bold;
    cursor: pointer;
    border: none;
    min-width: 100px;
    text-align: center;
}
.nav-btn.back-to-lobby { background: #333; }
.nav-btn:disabled { opacity: 0.3; cursor: default; }

.reader-controls { display: flex; align-items: center; gap: 10px; }

/* --- NEW SIDEBAR SETTINGS DESIGN --- */
#readingSettingsSidebar {
    position: fixed; top: 0; right: -280px; width: 280px; height: 100%;
    background: #0a0a0a; border-left: 1px solid var(--accent);
    z-index: 8000; padding: 25px; transition: 0.4s cubic-bezier(0.85, 0, 0.15, 1);
    box-shadow: -10px 0 30px rgba(0,0,0,0.9); display: flex; flex-direction: column;
}
#readingSettingsSidebar.show { right: 0; }

.sidebar-title { font-size: 16px; font-weight: 800; color: #fff; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 1px solid #333; padding-bottom: 10px;}

.sidebar-section-label { font-size: 11px; font-weight: 700; color: #666; text-transform: uppercase; margin: 20px 0 10px; letter-spacing: 1px;}

.sidebar-select-btn { width: 100%; padding: 12px; background: #1a1a1a; color: #fff; border: 1px solid #333; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: left; margin-bottom: 10px; transition: 0.3s; }
.sidebar-select-btn.active { background: var(--accent); border-color: var(--accent); }

/* --- TOGGLE SWITCH CSS --- */
.switch-container { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
.switch { position: relative; display: inline-block; width: 40px; height: 20px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 20px; }
.slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--accent); }
input:checked + .slider:before { transform: translateX(20px); }

.sidebar-chapter-list { flex: 1; overflow-y: auto; margin-top: 10px; display: flex; flex-direction: column; gap: 5px; }
.sidebar-chapter-opt { padding: 12px; background: rgba(255,255,255,0.03); border-radius: 6px; font-size: 13px; cursor: pointer; border: 1px solid transparent; }
.sidebar-chapter-opt:active { background: var(--accent); }

#chapterSelectPopup {
    position: fixed; bottom: -100%; left: 0; width: 100%; max-height: 60vh;
    background: #111; z-index: 7000; padding: 20px; border-radius: 20px 20px 0 0;
    overflow-y: auto; transition: 0.4s cubic-bezier(0.85, 0, 0.15, 1);
}
#chapterSelectPopup.show { bottom: 0; }
.chapter-option-item { padding: 15px; border-bottom: 1px solid #222; font-weight: bold; }

/* --- ADMIN PANEL PREMIUM RE-DESIGN --- */
#adminSidebar { 
    position:fixed; top:0; right:-320px; width:320px; height:100%; 
    background: #0a0a0a; backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); 
    padding:25px; transition: 0.5s cubic-bezier(0.85, 0, 0.15, 1); z-index:6000; 
    overflow-y:auto; box-shadow: -10px 0 30px rgba(0,0,0,0.8); 
}
#adminSidebar.show{ right:0; }

.admin-section-title {
    font-size: 14px; font-weight: 800; text-transform: uppercase; 
    letter-spacing: 1.5px; color: var(--text); margin: 25px 0 15px; 
    display: flex; align-items: center; gap: 10px;
}
.admin-section-title::before {
    content: ''; width: 3px; height: 15px; background: var(--accent); border-radius: 10px;
}

.input-label {
    font-size: 10px; font-weight: 700; color: #666; text-transform: uppercase; 
    margin-bottom: 6px; display: block; letter-spacing: 0.5px;
}

#adminSidebar input, #adminSidebar button, #adminSidebar select, #adminSidebar textarea { 
    width:100%; margin-bottom: 12px; outline: none; 
}

#adminSidebar input, #adminSidebar select, #adminSidebar textarea {
    background: #151515 !important; border: 1px solid #222 !important; 
    border-radius: 8px !important; padding: 10px 14px !important; 
    font-size: 13px !important; color: #fff !important;
}

#adminSidebar textarea { height: 100px; resize: none; font-family: inherit; }

.admin-primary-btn {
    background: var(--accent) !important; color: white !important; font-weight: 700 !important; 
    text-transform: uppercase !important; letter-spacing: 1px !important; border: none !important; 
    padding: 14px !important; border-radius: 8px !important; cursor: pointer; 
    box-shadow: 0 4px 15px rgba(255, 42, 42, 0.2); transition: 0.3s;
}
.admin-primary-btn:active { transform: scale(0.96); }

.admin-secondary-btn {
    background: #222 !important; color: #bbb !important; font-size: 12px !important; 
    font-weight: 600 !important; border: 1px solid #333 !important; padding: 10px !important; 
    border-radius: 8px !important; cursor: pointer;
}

.genre-select-container { 
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #111 !important; 
    padding: 12px !important; border-radius: 10px; border: 1px solid #222 !important;
    margin-bottom: 15px; max-height: 150px; overflow-y: auto; 
}
.genre-option { display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer; color: #bbb; }
.genre-option input { width: auto !important; margin: 0 !important; accent-color: var(--accent); }

#uploadStatus{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);padding:12px 25px;border-radius:50px;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);opacity:0;transition:.4s;z-index:7000; pointer-events: none; border: 1px solid rgba(255,255,255,0.1); font-weight: bold; text-align: center; min-width: 200px;}
#uploadStatus.show{opacity:1; bottom: 50px;}

.historyItem{display:flex;flex-direction:column; gap:10px; padding:15px; margin-bottom:15px; background:rgba(255,255,255,0.03); border-radius:12px; border: 1px solid rgba(255,255,255,0.05);}
.manga-header-info { display: flex; align-items: center; gap: 12px; }
.manga-header-info img { width:45px; height:60px; object-fit:cover; border-radius:6px; border: 1px solid rgba(255,255,255,0.1); }
.chapter-badge-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px; }
.chapter-chip { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.07); padding: 5px 10px; border-radius: 6px; font-size: 11px; color: #ccc; border: 1px solid rgba(255,255,255,0.05); }
.del-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: rgba(255,0,0,0.1); color: #ff4444; border-radius: 5px; cursor: pointer; transition: 0.2s;}
.del-btn:hover { background: #ff0000; color: white; }

/* PREMIUM TRASH ICON STYLE */
.manga-del-btn {
  margin-left: auto; color: #ff4444; cursor: pointer; padding: 8px; border-radius: 8px;
  background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.2);
  transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;
}
.manga-del-btn:active { transform: scale(0.85); background: #ff4444; color: #fff; box-shadow: 0 0 15px rgba(255, 68, 68, 0.5); }
.manga-del-btn svg { width: 18px; height: 18px; filter: drop-shadow(0 0 5px rgba(255, 68, 68, 0.3)); }

#bookmarkPage { display:none; padding: 20px; width: 100%; min-height: 100vh; background: var(--bg); position: fixed; top: 0; left: 0; z-index: 5500; overflow-y: auto; }
.bookmark-header { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
.bookmark-btn-sidebar { display: flex; align-items: center; gap: 12px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 20px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: 0.3s; }
.bookmark-btn-sidebar:active { transform: scale(0.95); background: var(--accent); }
.bookmark-icon-wrap { width: 35px; height: 35px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; }

</style>
</head>

<body>

<div id="intro">
  <div id="introBg"></div>
  <h1>Tomato Manga Zone</h1>
  <p>Ultimate Reading Experience</p>
  <button onclick="enterSite()">START READING</button>
</div>

<div id="mainContentWrapper" class="app-lobby">
    <div id="mainHeader">
      <div id="headerInner">
        <div id="searchContainer">
          <input type="text" placeholder="Explore your manga..." id="searchInput" onkeyup="liveSearch(this.value)" autocomplete="off">
          <span class="searchClose" onclick="toggleSearch(false)">‚úï</span>
          <div id="searchDropdown"></div>
        </div>
        <div class="iconBtn" id="openSearchBtn" onclick="toggleSearch(true)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </div>
        <div id="headerCenter">
          <span class="logo-main"><span class="t-red">TOMATO</span> MANGA</span>
          <span class="logo-sub">ZONE</span>
        </div>
        <div id="headerRight">
          <div class="iconBtn" id="themeBtn">
            <svg id="sunIcon" style="display:none;" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5 2.24 5 5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s-.45-1 1-1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s-1 .45-1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0 .55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0s-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0s-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41s-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41s-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></svg>
            <svg id="moonIcon" viewBox="0 0 24 24"><path d="M12.1 22c4.8 0 8.7-3.6 9-8.3-.5.4-1.1.7-1.7.9-1.2.4-2.4.5-3.6.2-3.1-.7-5.4-3.5-5.3-6.7.1-1.7.7-3.2 1.6-4.5-5.2-.4-9.6 3.7-9.6 8.9 0 5.2 4.3 9.5 9.6 9.5z"/></svg>
          </div>
          <div class="iconBtn" onclick="toggleAdmin()">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
          </div>
        </div>
      </div>
    </div>
    <div id="showcase"><div id="showcaseTrack"></div></div>
    <div id="popularTitleBar"><span class="pop-text">üî• Popular Now</span><div class="pop-line"></div></div>
    <div id="featuredBar"><div id="featuredTrack"></div></div>
    <div id="premDivider" class="premium-divider"></div>
    
    <div class="manga-list-header">
      <div class="accent-bar"></div>
      <h2>Manga List</h2>
    </div>

    <div id="mangaList"></div>
</div>

<div id="adminSidebar">
  <div class="bookmark-btn-sidebar" onclick="openBookmarkLobby()">
    <div class="bookmark-icon-wrap"><svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg></div>
    <span style="font-weight: bold; font-size: 15px;">My Bookmarks</span>
  </div>
  
  <div id="loginBox">
    <label class="input-label">SECURITY CHECK</label>
    <input type="password" id="adminPass" placeholder="Enter Admin Key">
    <button onclick="checkPass()" class="admin-primary-btn">ACCESS CONTROL</button>
  </div>
  
  <div id="adminForm" style="display:none">
    <div class="admin-section-title">Step 1: New Manga</div>
    
    <label class="input-label">Manga Title</label>
    <input id="mangaTitle" placeholder="Enter title...">
    
    <label class="input-label">Cover Image</label>
    <input type="file" id="mangaImg" accept="image/*" class="admin-secondary-btn">
    
    <label class="input-label">Select Genres</label>
    <div class="genre-select-container" id="adminGenreList"></div>
    
    <label class="input-label">Description</label>
    <textarea id="mangaDesc" placeholder="Brief story description..."></textarea>
    
    <label class="input-label">Rating</label>
    <input id="mangaRating" type="number" step="0.1" value="4.9">
    
    <button onclick="uploadManga()" id="createBtn" class="admin-primary-btn">Create Manga Entry</button>

    <div style="height:1px; background:#222; margin: 30px 0;"></div>

    <div class="admin-section-title">Step 2: Add Content</div>
    
    <label class="input-label">Select Target Manga</label>
    <select id="mangaSelect"></select>
    
    <label class="input-label">Chapter Name</label>
    <input id="chapterTitle" placeholder="e.g. Chapter 01">
    
    <label class="input-label">Manga Pages</label>
    <input type="file" id="chapterFiles" accept="image/*" multiple onchange="handleFiles(this.files)" style="display:none">
    <button onclick="document.getElementById('chapterFiles').click()" class="admin-secondary-btn">Select Page Images</button>
    <p id="fileStatus" style="font-size:10px; text-align:center; margin-bottom:10px; opacity:0.5;">No files selected</p>
    
    <button onclick="uploadChapter()" id="uploadBtn" class="admin-primary-btn">Publish Chapter</button>

    <div class="admin-section-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-right:5px;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14.5v-9l6 4.5-6 4.5z"/></svg>
        Database Management
    </div>
    <div id="historyList"></div>
  </div>
  
  <div id="adminBack" onclick="toggleAdmin()" style="margin-top:20px; opacity:0.5; font-size:13px; text-align:center; cursor:pointer;">‚Üê CLOSE PANEL</div>
</div>

<div id="bookmarkPage" class="app-lobby">
  <div class="bookmark-header">
    <button class="backBtn" onclick="closeBookmarkLobby()" style="margin:0">‚Üê BACK</button>
    <h2 style="font-weight: 900; letter-spacing: 1px;">MY BOOKMARK LIST</h2>
  </div>
  <div id="bookmarkList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:20px;"></div>
</div>

<div id="detailPage" class="app-lobby">
  <button class="backBtn" onclick="closeDetail()">‚Üê BACK</button>
  <div class="lobby-container" id="lobbyInfo"></div>
  
  <div class="wave-container">
    <div class="wave wave1"></div>
    <div class="wave wave2"></div>
  </div>

  <div class="chapter-list-section">
      <div class="chapter-list-header">Chapter List</div>
      <div id="chapterItemsContainer"></div>
  </div>
</div>

<div id="readingLobby" class="app-lobby">
    <div class="reading-header" id="readingHeader">
        <div onclick="closeReadingLobby()" style="cursor:pointer; font-weight:900;">‚Üê BACK</div>
        <div id="readingTitle" style="font-weight:bold;">Chapter Name</div>
        <div class="reader-controls">
            <div class="iconBtn" onclick="toggleReadingSidebar(event)">
                <svg viewBox="0 0 24 24" fill="white"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
            </div>
        </div>
    </div>

    <div id="readingSettingsSidebar">
        <div class="sidebar-title">Reading Menu</div>
        
        <div class="sidebar-section-label">General Settings</div>
        <div class="switch-container">
            <span>Show Head Bar</span>
            <label class="switch">
                <input type="checkbox" id="headbar-toggle" checked>
                <span class="slider"></span>
            </label>
        </div>

        <div class="sidebar-section-label">Reading Lobby Mode</div>
        <button id="lobbyToggleBtn" class="sidebar-select-btn" onclick="toggleFullScreenLobby()">Enable Full Screen</button>
        
        <div class="sidebar-section-label">Viewing Mode</div>
        <button id="modeScroll" class="sidebar-select-btn active" onclick="setReadMode('scroll')">Vertical Scroll</button>
        <button id="modePage" class="sidebar-select-btn" onclick="setReadMode('page')">Page by Page</button>

        <div class="sidebar-section-label">Select Chapter</div>
        <div id="sidebarChapterList" class="sidebar-chapter-list"></div>
        
        <div style="margin-top:auto; padding-top:20px; border-top: 1px solid #222;">
            <button class="admin-secondary-btn" onclick="toggleReadingSidebar()">CLOSE MENU</button>
        </div>
    </div>

    <div id="pagesContainer"></div>

    <div class="reading-nav-panel">
        <button class="nav-btn back-to-lobby" id="backToDetailBtn">Back</button>
        <button class="nav-btn" id="nextChapterBtn">Next</button>
    </div>
</div>

<div id="uploadStatus"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, increment, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // --- ADDED SECURITY SYSTEM ---
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.onkeydown = function(e) {
      if (e.keyCode == 123) return false;
      if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0))) return false;
      if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
  };

  setInterval(function() {
      const threshold = 160;
      if (window.outerWidth - window.innerWidth > threshold || window.outerHeight - window.innerHeight > threshold) {
          document.body.innerHTML = "<h1 style='color:red; text-align:center; margin-top:50px;'>Security Alert: Developer Tools Detected!</h1>";
          setTimeout(() => { window.location.reload(); }, 2000);
      }
  }, 1000);

  async function secureImageLoad(imgElement, imageUrl) {
      return new Promise((resolve) => {
          fetch(imageUrl).then(res => res.blob()).then(blob => {
              const objectURL = URL.createObjectURL(blob);
              imgElement.src = objectURL;
              imgElement.onload = () => {
                  imgElement.style.opacity = "1";
                  URL.revokeObjectURL(objectURL);
                  resolve();
              };
          }).catch(e => {
              imgElement.src = imageUrl;
              imgElement.onload = () => { 
                imgElement.style.opacity = "1"; 
                resolve();
              };
          });
      });
  }
  // --- SECURITY SYSTEM END ---

  // CLOUDINARY CONFIG
  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dxbelpram/image/upload";
  const UPLOAD_PRESET = "manga_upload";

  const firebaseConfig = {
    apiKey: "AIzaSyBBr71Dk5pFn8Uk1nn5D0oBYeQWPvFcKX4",
    authDomain: "tomato-manga-zone.firebaseapp.com",
    projectId: "tomato-manga-zone",
    storageBucket: "tomato-manga-zone.firebasestorage.app",
    messagingSenderId: "28164821885",
    appId: "1:28164821885:web:d23cc3faa8d8dbae22f214",
    measurementId: "G-BNR7BQP2VC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  window.mangas = [];
  
  // INFINITE SCROLL SETTINGS
  let currentLimit = 6;
  let unsubscribeManga = null;
  let shouldAnimateMangas = true;
  const lobbyScrollMemory = {};

  // --- GLOBAL NAVIGATION CONTROLLER (BACK BUTTON FIX) ---
  window.navigateTo = function(targetId) {
    localStorage.setItem('activeLobbyId', targetId);
    
    // BACK BUTTON LOGIC: History ·Äë·Ä≤·Äô·Äæ·Ä¨ State ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ ·Äê·Ä≠·ÄØ·Ä∏·Äï·Ä±·Ä∏·Äô·Äö·Ä∫
    history.pushState({ lobbyId: targetId }, "");

    const allLobbies = document.querySelectorAll('.app-lobby');
    const currentLobby = Array.from(allLobbies).find(l => getComputedStyle(l).display === 'block');
    if (currentLobby) {
      lobbyScrollMemory[currentLobby.id] = currentLobby.scrollTop;
      currentLobby.style.display = 'none';
    }
    const target = document.getElementById(targetId);
    if (target) {
      target.style.display = 'block';
      const savedPos = lobbyScrollMemory[targetId] || 0;
      if(targetId === 'mainContentWrapper') shouldAnimateMangas = false;
      setTimeout(() => { target.scrollTop = savedPos; }, 10);
    }
  };

  // BACK BUTTON INTERCEPTION - ·Ä°·Äú·Ä≠·ÄØ·Ä°·Äú·Äª·Ä±·Ä¨·ÄÄ·Ä∫ ·Ä°·ÄÜ·ÄÑ·Ä∑·Ä∫·ÄÜ·ÄÑ·Ä∑·Ä∫ ·Äï·Äº·Äî·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äï·Ä±·Ä∏·Äô·Ää·Ä∑·Ä∫ Logic
  window.onpopstate = function(event) {
    // ·ÅÅ·Åã Sidebar (Menu) ·Äï·ÄΩ·ÄÑ·Ä∑·Ä∫·Äî·Ä±·Äõ·ÄÑ·Ä∫ Sidebar ·ÄÄ·Ä≠·ÄØ·Äï·Ä≤ ·Ä°·Äõ·ÄÑ·Ä∫·Äï·Ä≠·Äê·Ä∫·Äô·Äö·Ä∫
    const readingSidebar = document.getElementById('readingSettingsSidebar');
    const adminSidebar = document.getElementById('adminSidebar');
    
    if (readingSidebar && readingSidebar.classList.contains('show')) {
        readingSidebar.classList.remove('show');
        history.pushState({ lobbyId: 'readingLobby' }, ""); // Web ·Äë·Ä≤·ÄÄ·Äî·Ä± ·Äô·Äë·ÄΩ·ÄÄ·Ä∫·Ä°·Ä±·Ä¨·ÄÑ·Ä∫ History ·ÄÄ·Ä≠·ÄØ ·Äï·Äº·Äî·Ä∫·Äë·Ä≠·Äî·Ä∫·Ä∏·Äô·Äö·Ä∫
        return;
    }
    
    if (adminSidebar && adminSidebar.classList.contains('show')) {
        adminSidebar.classList.remove('show');
        history.pushState({ lobbyId: 'mainContentWrapper' }, "");
        return;
    }

    // ·ÅÇ·Åã Lobby ·Ä°·ÄÜ·ÄÑ·Ä∑·Ä∫·ÄÜ·ÄÑ·Ä∑·Ä∫·Ä°·Äê·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·Äï·Äº·Äî·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äô·Äö·Ä∫ (Intro > Main > Detail > Reading)
    const activeLobby = localStorage.getItem('activeLobbyId');
    
    if (activeLobby === 'readingLobby') {
        // Reading mode ·ÄÄ·Äî·Ä± Back ·Äî·Äæ·Ä≠·Äï·Ä∫·Äõ·ÄÑ·Ä∫ Detail Page ·ÄÄ·Ä≠·ÄØ ·Äï·Äº·Äî·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äô·Äö·Ä∫
        closeReadingLobby();
    } else if (activeLobby === 'detailPage') {
        // Detail Page ·ÄÄ·Äî·Ä± Back ·Äî·Äæ·Ä≠·Äï·Ä∫·Äõ·ÄÑ·Ä∫ Main Lobby ·ÄÄ·Ä≠·ÄØ ·Äï·Äº·Äî·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äô·Äö·Ä∫
        closeDetail();
    } else if (activeLobby === 'bookmarkPage') {
        // Bookmark ·ÄÄ·Äî·Ä± Back ·Äî·Äæ·Ä≠·Äï·Ä∫·Äõ·ÄÑ·Ä∫ Main ·ÄÄ·Ä≠·ÄØ ·Äï·Äº·Äî·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äô·Äö·Ä∫
        closeBookmarkLobby();
    } else if (activeLobby === 'mainContentWrapper') {
        // Main Lobby ·Äô·Äæ·Ä¨ ·Äõ·Äæ·Ä≠·Äî·Ä±·Äõ·ÄÑ·Ä∫·Äê·Ä±·Ä¨·Ä∑ ·Äñ·ÄØ·Äî·Ä∫·Ä∏ Back ·Äî·Äæ·Ä≠·Äï·Ä∫·Äõ·ÄÑ·Ä∫ Browser ·Äë·Ä≤·ÄÄ·Äî·Ä± ·Äê·ÄÄ·Äö·Ä∫·Äë·ÄΩ·ÄÄ·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äô·Äö·Ä∫ (·Äí·Ä´·Äô·Äæ·Äô·Äü·ÄØ·Äê·Ä∫ confirm ·Äï·Äº·Äú·Ä≠·ÄØ·Ä∑·Äõ·Äê·Äö·Ä∫)
    }
  };

  document.addEventListener('touchmove', function (e) {
      const activeLobby = document.querySelector('.app-lobby[style*="display: block"]');
      if (activeLobby && activeLobby.scrollTop <= 0 && e.touches[0].clientY > 10) { }
  }, { passive: false });

  const genreOptions = ["Action", "Adventure", "Comedy", "Drama", "Fantasy", "Horror", "Mystery", "Romance", "Sci-Fi", "Slice of Life", "Sports", "Supernatural", "Thriller", "Seinen", "Shounen"];
  const adminGenreDiv = document.getElementById('adminGenreList');
  adminGenreDiv.innerHTML = genreOptions.map(g => `<label class="genre-option"><input type="checkbox" value="${g}" class="genre-checkbox"> ${g}</label>`).join('');

  const list = document.getElementById('mangaList');
  list.innerHTML = Array(6).fill(0).map(() => `<div class="skeleton" style="width:100%; aspect-ratio:3/4;"></div>`).join('');
  
  // --- NEW: IMAGE COMPRESSION LOGIC ---
  async function compressImage(file) {
      return new Promise((resolve) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = (event) => {
              const img = new Image();
              img.src = event.target.result;
              img.onload = () => {
                  const canvas = document.createElement('canvas');
                  const ctx = canvas.getContext('2d');
                  canvas.width = img.width;
                  canvas.height = img.height;
                  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                  canvas.toBlob((blob) => {
                      const compressedFile = new File([blob], file.name.replace(/\.[^/.]+$/, "") + ".jpg", {
                          type: 'image/jpeg',
                          lastModified: Date.now(),
                      });
                      resolve(compressedFile);
                  }, 'image/jpeg', 0.9); // 0.9 Quality
              };
          };
      });
  }

  async function processAndUpload(file) {
      const optimizedFile = await compressImage(file);
      const formData = new FormData();
      formData.append("file", optimizedFile);
      formData.append("upload_preset", UPLOAD_PRESET);

      try {
          const res = await fetch(CLOUDINARY_URL, {
              method: "POST",
              body: formData
          });
          const data = await res.json();
          return data.secure_url;
      } catch (e) {
          console.error("Cloudinary Error:", e);
          throw e;
      }
  }

  const introBg = document.getElementById('introBg');
  for(let i=0;i<42;i++){ introBg.innerHTML+=`<svg viewBox="0 0 160 220"><rect width="160" height="220" fill="#111"/><rect x="10" y="10" width="140" height="60" fill="#000"/><rect x="10" y="80" width="60" height="50" fill="#000"/><rect x="80" y="80" width="70" height="120" fill="#000"/></svg>`; }

  window.handleFiles = function(files) { document.getElementById('fileStatus').innerText = files.length + " pages ready."; }

  function startMangaListener() {
      if (unsubscribeManga) unsubscribeManga();
      const mangaQuery = query(collection(db, "mangas"), orderBy("lastUpdated", "desc"), limit(currentLimit));
      
      unsubscribeManga = onSnapshot(mangaQuery, (snapshot) => {
          window.mangas = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
          renderPublic(); renderFeatured(); renderShowcase(); renderHistory(); updateMangaSelect(); renderBookmarks();
          if(document.getElementById('detailPage').style.display === "block" && window.currentOpenMangaFbId) {
              openManga(window.currentOpenMangaFbId);
          }
      });
  }

  document.getElementById('mainContentWrapper').addEventListener('scroll', (e) => {
      const { scrollTop, scrollHeight, clientHeight } = e.target;
      if (scrollTop + clientHeight >= scrollHeight - 300) {
          if (window.mangas.length >= currentLimit) {
              currentLimit += 6;
              startMangaListener();
          }
      }
  });

  startMangaListener();

  let searchTimer;
  window.liveSearch = function(val) {
    const dropdown = document.getElementById('searchDropdown');
    clearTimeout(searchTimer);
    if(!val.trim()) { dropdown.style.display = "none"; return; }

    searchTimer = setTimeout(() => {
        const queryStr = val.toLowerCase();
        const filtered = window.mangas.filter(m => m.name.toLowerCase().includes(queryStr)).slice(0, 5);
        if(filtered.length > 0) {
            dropdown.innerHTML = filtered.map(m => `
                <div class="search-item" onclick="openManga('${m.fbId}'); toggleSearch(false);">
                    <img src="${m.img}" alt="cover">
                    <div class="search-item-info">
                        <span class="search-item-title">${m.name}</span>
                        <span class="search-item-meta">‚≠ê ${m.rating || '4.9'} | ${(m.genres || ['Action'])[0]}</span>
                    </div>
                </div>`).join('');
            dropdown.style.display = "flex";
        } else {
            dropdown.innerHTML = `<div style="padding:15px; text-align:center; font-size:12px; opacity:0.5;">No results found</div>`;
            dropdown.style.display = "flex";
        }
    }, 300);
  }

  window.uploadManga = async function() {
    const title = document.getElementById('mangaTitle').value;
    const imgInput = document.getElementById('mangaImg');
    const description = document.getElementById('mangaDesc').value;
    const rating = document.getElementById('mangaRating').value || "4.9";
    const btn = document.getElementById('createBtn');
    const selectedGenres = Array.from(document.querySelectorAll('.genre-checkbox:checked')).map(cb => cb.value);
    if(!title || !imgInput.files[0] || selectedGenres.length === 0) return showStatus("Required fields/Genres empty","fail");
    btn.disabled = true; showStatus("Optimizing & Uploading...", "success");
    try {
      const imageUrl = await processAndUpload(imgInput.files[0]);
      const now = Date.now();
      await addDoc(collection(db, "mangas"), { 
        id: now, 
        name: title, 
        img: imageUrl, 
        rating: rating, 
        genres: selectedGenres, 
        description: description || "No description available.", 
        chapters: [],
        uploadedAt: new Date().toLocaleString(),
        lastUpdated: now 
      });
      document.getElementById('mangaTitle').value = ""; document.getElementById('mangaDesc').value = ""; imgInput.value = ""; document.querySelectorAll('.genre-checkbox').forEach(cb => cb.checked = false);
      showStatus("Manga Created! ‚ú®","success");
    } catch(e) { showStatus("Cloud Error","fail"); }
    btn.disabled = false;
  }

  window.uploadChapter = async function() {
    const selectedFbId = document.getElementById('mangaSelect').value;
    const cTitle = document.getElementById('chapterTitle').value;
    const files = Array.from(document.getElementById('chapterFiles').files);
    const btn = document.getElementById('uploadBtn');
    if(!selectedFbId || !cTitle || files.length === 0) return showStatus("Missing information!","fail");
    btn.disabled = true; 
    const cloudUrls = [];
    const totalFiles = files.length;
    try {
      for (let i = 0; i < totalFiles; i++) {
          showStatus(`Optimizing: Page ${i + 1} / ${totalFiles} ... üçÖ`, "success");
          const url = await processAndUpload(files[i]);
          cloudUrls.push(url);
      }
      const targetManga = window.mangas.find(m => m.fbId === selectedFbId);
      const now = Date.now();
      const updatedChapters = [...(targetManga.chapters || []), { title: cTitle, pages: cloudUrls, views: 0, timestamp: now }];
      await updateDoc(doc(db, "mangas", selectedFbId), { chapters: updatedChapters, lastUpdated: now });
      document.getElementById('chapterTitle').value = ""; document.getElementById('chapterFiles').value = ""; document.getElementById('fileStatus').innerText = "No files selected";
      showStatus(`Published ${totalFiles} pages! ‚úÖ`, "success");
    } catch(e) { showStatus("Upload Failed!", "fail"); } finally { btn.disabled = false; }
  }

  window.deleteManga = async function(fbId) { 
    try { showStatus("Removing Manga...", "success"); await deleteDoc(doc(db, "mangas", fbId)); showStatus("Removed! ‚ú®", "success"); } catch(e) { showStatus("Error", "fail"); } 
  }

  window.deleteChapter = async function(mId, idx) { 
    try { 
      const m = window.mangas.find(x => x.fbId === mId); 
      const up = m.chapters.filter((_, i) => i !== idx); 
      showStatus("Deleting Chapter...", "success");
      await updateDoc(doc(db, "mangas", mId), { chapters: up }); 
      showStatus("Deleted! üî•", "success"); 
    } catch(e) { showStatus("Error", "fail"); } 
  }

  window.enterSite = () => {
    const intro = document.getElementById('intro');
    const lobby = document.getElementById('mainContentWrapper');
    intro.classList.add("fade-out");
    setTimeout(() => { 
        intro.style.display = "none"; 
        lobby.classList.add("animate-in"); 
        const savedLobby = localStorage.getItem('activeLobbyId');
        const savedMangaFbId = localStorage.getItem('currentOpenMangaFbId');
        const savedChapterIdx = localStorage.getItem('currentReadChapterIdx');
        if (savedLobby && savedLobby !== 'intro') {
            if (savedLobby === 'readingLobby' && savedMangaFbId && savedChapterIdx !== null) {
                window.currentOpenMangaFbId = savedMangaFbId;
                openReadingLobby(savedMangaFbId, parseInt(savedChapterIdx));
            } 
            else if (savedLobby === 'detailPage' && savedMangaFbId) { openManga(savedMangaFbId); } 
            else if (savedLobby === 'bookmarkPage') { openBookmarkLobby(); }
            else { navigateTo('mainContentWrapper'); }
        } else { navigateTo('mainContentWrapper'); }
        shouldAnimateMangas = true;
        renderPublic();
        setTimeout(() => { shouldAnimateMangas = false; }, 2000);
    }, 800);
  }

  window.toggleSearch = (show) => {
    const container = document.getElementById('searchContainer');
    const logo = document.getElementById('headerCenter');
    const dropdown = document.getElementById('searchDropdown');
    if(show) { container.classList.add('active'); logo.classList.add('hide'); document.getElementById('searchInput').focus(); } 
    else { container.classList.remove('active'); logo.classList.remove('hide'); document.getElementById('searchInput').value = ""; dropdown.style.display = "none"; }
  }

  document.getElementById('themeBtn').onclick = function() {
    const sun = document.getElementById('sunIcon'), moon = document.getElementById('moonIcon');
    const iconWrapper = this.querySelector('svg:not([style*="display:none"])');
    iconWrapper.classList.add('rotate-anim');
    setTimeout(() => {
        document.body.classList.toggle("light");
        const isLight = document.body.classList.contains("light");
        sun.style.display = isLight ? "block" : "none";
        moon.style.display = isLight ? "none" : "block";
        iconWrapper.classList.remove('rotate-anim');
    }, 300);
  }

  window.toggleAdmin = () => {
    const sidebar = document.getElementById('adminSidebar');
    sidebar.classList.toggle("show");
    if(sidebar.classList.contains('show')) {
        // Admin Sidebar ·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äõ·ÄÑ·Ä∫ History ·Äô·Äæ·Ä¨ ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äú·Ä≤·Äô·Äæ·ÄØ ·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ ·Äú·ÄØ·Äï·Ä∫·Äë·Ä¨·Ä∏·Äô·Äö·Ä∫
        history.pushState({ admin: true }, "");
    }
  }

  const ADMIN_KEY = "teamtomatokioshi";
  window.checkPass = () => { 
    const input = document.getElementById('adminPass').value.trim();
    if(input === ADMIN_KEY){ 
        document.getElementById('loginBox').style.display="none"; 
        document.getElementById('adminForm').style.display="block"; 
        showStatus("Access Granted! ‚ú®","success"); 
    } else { showStatus("Wrong Key! ‚ùå","fail"); }
  }

  function showStatus(t,type){ const s = document.getElementById('uploadStatus'); s.innerText=t; s.className=type+" show"; setTimeout(()=>s.className="",3000); }
  function updateMangaSelect(){ document.getElementById('mangaSelect').innerHTML = window.mangas.map(m => `<option value="${m.fbId}">${m.name}</option>`).join(''); }

  function shouldShowNewBadge(manga) {
      if (!manga.chapters || manga.chapters.length === 0) return false;
      const latestChapter = manga.chapters[manga.chapters.length - 1];
      if (!latestChapter.timestamp) return false;
      const now = Date.now();
      return (now - latestChapter.timestamp) < (24 * 60 * 60 * 1000);
  }

  function isNewCover(manga) {
      if (!manga.lastUpdated) return false;
      const now = Date.now();
      return (now - manga.lastUpdated) < (24 * 60 * 60 * 1000);
  }

  function renderPublic(){
    if(window.mangas.length === 0) return;
    document.getElementById('mangaList').innerHTML = window.mangas.map((m, i) => {
      const animClass = shouldAnimateMangas ? 'animate' : '';
      const delay = shouldAnimateMangas ? `style="animation-delay: ${0.8 + (i * 0.05)}s"` : '';
      return `
      <div class="manga ${animClass}" onclick="openManga('${m.fbId}')" ${delay}>
        ${shouldShowNewBadge(m) ? '<div class="new-chapter-badge">New Chapter Update</div>' : ''}
        ${isNewCover(m) ? '<div class="premium-cover-badge">New</div>' : ''}
        <img src="${m.img}" loading="lazy"><p>${m.name}</p>
      </div>`;
    }).join('');
  }

  let isDown = false, startX, currentPos = 0, animationId;
  const scrollSpeed = 0.5;

  function renderFeatured(){
    const bar = document.getElementById('featuredBar'), track = document.getElementById('featuredTrack'), title = document.getElementById('popularTitleBar'), divider = document.getElementById('premDivider');
    if(window.mangas.length > 0) { 
      bar.style.display="block"; title.style.display="flex"; divider.style.display="block";
      const itemsHtml = window.mangas.map(m => `<div class="featuredItem" onclick="openManga('${m.fbId}')"><img src="${m.img}" loading="lazy"></div>`).join('');
      track.innerHTML = itemsHtml + itemsHtml + itemsHtml; 
      startAutoScroll(); initDragEvents(bar, track);
    }
  }

  function startAutoScroll() {
    cancelAnimationFrame(animationId);
    const track = document.getElementById('featuredTrack');
    function step() { if (!isDown && track) { currentPos -= scrollSpeed; const singleSetWidth = track.scrollWidth / 3; if (Math.abs(currentPos) >= singleSetWidth) currentPos = 0; track.style.transform = `translateX(${currentPos}px)`; } animationId = requestAnimationFrame(step); }
    animationId = requestAnimationFrame(step);
  }

  function initDragEvents(bar, track) {
    const handleStart = (e) => { isDown = true; startX = (e.pageX || e.touches[0].pageX) - currentPos; };
    const handleEnd = () => { isDown = false; };
    const handleMove = (e) => { if (!isDown) return; const x = (e.pageX || e.touches[0].pageX); currentPos = x - startX; track.style.transform = `translateX(${currentPos}px)`; };
    bar.addEventListener('mousedown', handleStart); bar.addEventListener('touchstart', handleStart);
    window.addEventListener('mouseup', handleEnd); window.addEventListener('touchend', handleEnd);
    bar.addEventListener('mousemove', handleMove); bar.addEventListener('touchmove', handleMove);
  }

  function renderShowcase(){
    const sc = document.getElementById('showcase');
    if(window.mangas.length > 0) sc.style.display="block";
    document.getElementById('showcaseTrack').innerHTML = window.mangas.map(m => `<div class="showcaseItem"><img src="${m.img}"></div>`).join('');
    if(window.showcaseTimer) clearInterval(window.showcaseTimer);
    let index = 0;
    window.showcaseTimer = setInterval(() => { 
        index = (index + 1) % window.mangas.length; 
        const track = document.getElementById('showcaseTrack');
        if(track) track.style.transform = `translateX(-${index * 100}%)`; 
    }, 5000);
  }

  function renderHistory(){
    document.getElementById('historyList').innerHTML = window.mangas.map(m => `
      <div class="historyItem">
        <div class="manga-header-info">
          <img src="${m.img}" loading="lazy">
          <div class="historyInfo">
            <b style="font-size:14px; color: var(--text);">${m.name}</b><br>
            <small style="opacity:0.5; font-size:10px; display:block; margin-top:2px;">üìÖ ${m.uploadedAt || 'Recently'}</small>
          </div>
          <div class="manga-del-btn" onclick="deleteManga('${m.fbId}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
          </div>
        </div>
        <div class="chapter-badge-container">
          ${(m.chapters || []).map((ch, idx) => `<div class="chapter-chip"><span>${ch.title}</span><div class="del-btn" onclick="deleteChapter('${m.fbId}', ${idx})">‚úï</div></div>`).join('')}
        </div>
      </div>`).join('');
  }

  async function markChapterReadAndCount(mangaId, chapterIdx) {
    let readHistory = JSON.parse(localStorage.getItem('read_chapters') || "{}");
    if(!readHistory[mangaId]) readHistory[mangaId] = [];
    if(!readHistory[mangaId].includes(chapterIdx)) {
        readHistory[mangaId].push(chapterIdx);
        localStorage.setItem('read_chapters', JSON.stringify(readHistory));
        try {
          const m = window.mangas.find(x => x.fbId === mangaId);
          if(m && m.chapters && m.chapters[chapterIdx]) {
            const upChapters = [...m.chapters];
            upChapters[chapterIdx].views = (upChapters[chapterIdx].views || 0) + 1;
            await updateDoc(doc(db, "mangas", mangaId), { chapters: upChapters });
          }
        } catch(e) { }
    }
  }

  function isChapterRead(mangaId, chapterIdx) {
    let readHistory = JSON.parse(localStorage.getItem('read_chapters') || "{}");
    return readHistory[mangaId] && readHistory[mangaId].includes(chapterIdx);
  }

  window.openManga = function(fbId){
    if (isDown) return;
    localStorage.setItem('currentOpenMangaFbId', fbId);
    sessionStorage.setItem('active_lobby_source', document.getElementById('bookmarkPage').style.display === "block" ? 'bookmark' : 'main');
    window.currentOpenMangaFbId = fbId;
    const m = window.mangas.find(x => x.fbId === fbId);
    if(!m) return;
    
    // Lobby ·Ä°·Äû·ÄÖ·Ä∫·ÄÄ·Ä≠·ÄØ ·Äû·ÄΩ·Ä¨·Ä∏·Äô·Äö·Ä∫
    navigateTo('detailPage');

    const genresHtml = (m.genres || ["Action"]).map(g => `<span class="genre-tag">${g}</span>`).join('');
    const isBookmarked = JSON.parse(localStorage.getItem('bookmarks') || "[]").includes(fbId);
    document.getElementById('lobbyInfo').innerHTML = `
      <div class="lobby-top">
          <div class="lobby-left"><img src="${m.img}"><h2 class="manga-title">${m.name}</h2></div>
          <div class="lobby-right">
            <div class="manga-rating">‚≠ê ${m.rating || '4.9'}</div>
            <div class="manga-genres">${genresHtml}</div>
            <button class="bookmark-toggle-btn ${isBookmarked ? 'active' : ''}" onclick="toggleBookmark('${fbId}')">${isBookmarked ? '‚úì BOOKMARKED' : '+ ADD BOOKMARK'}</button>
          </div>
      </div>
      <div class="manga-title-wrap"><div class="manga-description">${m.description || 'No description available.'}</div></div>`;
    let html = "";
    if(!m.chapters || m.chapters.length === 0) html = "<p style='text-align:center; opacity:0.3; padding:50px;'>NO CHAPTERS YET</p>";
    else {
      m.chapters.forEach((ch, idx) => {
        html += `
          <div class="chapter-item ${isChapterRead(fbId, idx) ? 'read' : ''}" onclick="openReadingLobby('${fbId}', ${idx})">
            <span>${ch.title}</span><div class="view-count"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" opacity="0.7"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> ${ch.views || 0}</div>
          </div>`;
      });
    }
    document.getElementById('chapterItemsContainer').innerHTML = html;
  }

  let currentReadMode = 'scroll'; 
  let currentPageIndex = 0;
  let totalPages = 0;
  let lastScrollTop = 0;

  window.openReadingLobby = async function(fbId, chIdx) {
      const m = window.mangas.find(x => x.fbId === fbId);
      if(!m) return;
      const ch = m.chapters[chIdx];
      await markChapterReadAndCount(fbId, chIdx);
      localStorage.setItem('currentOpenMangaFbId', fbId);
      localStorage.setItem('currentReadChapterIdx', chIdx);
      
      // Reading Lobby ·Äë·Ä≤·ÄÄ·Ä≠·ÄØ ·Äû·ÄΩ·Ä¨·Ä∏·Äô·Äö·Ä∫
      navigateTo('readingLobby');

      document.getElementById('readingTitle').innerText = ch.title;
      totalPages = ch.pages.length;
      currentPageIndex = 0;
      
      // Update Sidebar Chapter List
      document.getElementById('sidebarChapterList').innerHTML = m.chapters.map((c, i) => `
        <div class="sidebar-chapter-opt ${i === chIdx ? 'active' : ''}" onclick="openReadingLobby('${fbId}', ${i}); toggleReadingSidebar();">
            ${c.title}
        </div>`).join('');

      document.getElementById('backToDetailBtn').onclick = () => closeReadingLobby();
      const nextBtn = document.getElementById('nextChapterBtn');
      if(chIdx + 1 < m.chapters.length) { nextBtn.disabled = false; nextBtn.innerText = "Next"; nextBtn.onclick = () => openReadingLobby(fbId, chIdx + 1); } 
      else { nextBtn.disabled = true; nextBtn.innerText = "End"; }
      
      const headbarToggle = document.getElementById('headbar-toggle');
      const savedStatus = localStorage.getItem('headBarStatus') !== 'off';
      headbarToggle.checked = savedStatus;
      applyHeadBarSetting(savedStatus);

      applyReadMode();
      renderPagesSequentially(ch.pages);
  }

  function applyHeadBarSetting(show) {
      const header = document.getElementById('readingHeader');
      const container = document.getElementById('pagesContainer');
      if(show) { header.classList.remove('hidden'); container.style.marginTop = "80px"; } 
      else { header.classList.add('hidden'); container.style.marginTop = "0"; }
  }

  document.getElementById('headbar-toggle').addEventListener('change', function() {
      applyHeadBarSetting(this.checked);
      localStorage.setItem('headBarStatus', this.checked ? 'on' : 'off');
  });

  document.getElementById('readingLobby').addEventListener('scroll', function(e) {
      if(currentReadMode !== 'scroll') return;
      const st = e.target.scrollTop;
      const header = document.getElementById('readingHeader');
      const isAutoOff = localStorage.getItem('headBarStatus') === 'off';

      if(isAutoOff) {
          if (st > lastScrollTop && st > 100) { header.classList.add('hidden'); } 
          else { header.classList.remove('hidden'); }
      }
      lastScrollTop = st <= 0 ? 0 : st;
  });

  // --- UPDATED: SEQUENTIAL LOADING & PLACEHOLDERS ---
  async function renderPagesSequentially(pages) {
      const container = document.getElementById('pagesContainer');
      container.innerHTML = ''; 
      
      const imgElements = [];

      // ·ÅÅ·Åã Placeholder Box ·Äê·ÄΩ·Ä± ·Ä°·Äõ·ÄÑ·Ä∫·ÄÜ·Ä±·Ä¨·ÄÄ·Ä∫·Äë·Ä¨·Ä∏·Äô·Äö·Ä∫
      pages.forEach((p, index) => {
          const wrapper = document.createElement('div');
          wrapper.className = currentReadMode === 'scroll' ? 'page-placeholder' : 'page-item';
          
          const img = document.createElement('img');
          img.style.opacity = "0";
          img.style.transition = "opacity 0.5s ease";
          
          wrapper.appendChild(img);
          container.appendChild(wrapper);
          imgElements.push({ img, url: p, wrapper });
      });

      // ·ÅÇ·Åã ·Äê·ÄÖ·Ä∫·Äï·ÄØ·Ä∂·Äï·Äº·ÄÆ·Ä∏·Äô·Äæ ·Äê·ÄÖ·Ä∫·Äï·ÄØ·Ä∂ Loading ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
      for (let i = 0; i < imgElements.length; i++) {
          await secureImageLoad(imgElements[i].img, imgElements[i].url);
          // ·Äï·ÄØ·Ä∂·Äï·Ä±·Ä´·Ä∫·Äú·Ä¨·Äõ·ÄÑ·Ä∫ Placeholder background ·ÄÄ·Ä≠·ÄØ ·Äñ·Äª·ÄÄ·Ä∫·Äô·Äö·Ä∫
          imgElements[i].wrapper.style.background = 'transparent';
          imgElements[i].wrapper.classList.remove('page-placeholder');
      }
      
      if(currentReadMode === 'page') container.style.transform = `translateX(0)`;
  }

  window.toggleReadingSidebar = (e) => {
      if(e) e.stopPropagation();
      const sidebar = document.getElementById('readingSettingsSidebar');
      sidebar.classList.toggle('show');
      if(sidebar.classList.contains('show')) {
          history.pushState({ sidebar: 'reading' }, "");
      }
  };

  window.toggleFullScreenLobby = () => {
    const header = document.getElementById('readingHeader');
    const btn = document.getElementById('lobbyToggleBtn');
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().then(() => {
            header.style.display = 'none';
            btn.innerText = "Exit Full Screen";
            btn.classList.add('active');
        });
    } else {
        document.exitFullscreen();
    }
    toggleReadingSidebar();
  };

  document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
          document.getElementById('readingHeader').style.display = 'flex';
          const btn = document.getElementById('lobbyToggleBtn');
          btn.innerText = "Enable Full Screen";
          btn.classList.remove('active');
      }
  });

  window.setReadMode = function(mode) {
      currentReadMode = mode;
      document.getElementById('modeScroll').classList.toggle('active', mode === 'scroll');
      document.getElementById('modePage').classList.toggle('active', mode === 'page');
      
      const m = window.mangas.find(x => x.fbId === window.currentOpenMangaFbId);
      const chIdx = parseInt(localStorage.getItem('currentReadChapterIdx'));
      applyReadMode(); 
      renderPagesSequentially(m.chapters[chIdx].pages);
      toggleReadingSidebar();
  };

  function applyReadMode() {
      const lobby = document.getElementById('readingLobby');
      if(currentReadMode === 'page') { lobby.classList.add('page-mode'); initPageTouchEvents(); } 
      else { lobby.classList.remove('page-mode'); }
  }

  function initPageTouchEvents() {
      const container = document.getElementById('pagesContainer');
      let touchStartX = 0, touchStartY = 0, isMoving = false;
      container.ontouchstart = e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; isMoving = true; container.style.transition = 'none'; };
      container.ontouchmove = e => {
          if (!isMoving) return;
          const currentX = e.touches[0].clientX, currentY = e.touches[0].clientY;
          if (Math.abs(currentX - touchStartX) > Math.abs(currentY - touchStartY)) {
            container.style.transform = `translateX(${-(currentPageIndex * window.innerWidth) + (currentX - touchStartX)}px)`;
            e.preventDefault();
          }
      };
      container.ontouchend = e => {
          if (!isMoving) return; isMoving = false;
          container.style.transition = 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)';
          const diff = touchStartX - e.changedTouches[0].clientX;
          if (Math.abs(diff) > window.innerWidth / 10) { 
              if (diff > 0 && currentPageIndex < totalPages - 1) currentPageIndex++;
              else if (diff < 0 && currentPageIndex > 0) currentPageIndex--;
          }
          container.style.transform = `translateX(-${currentPageIndex * 100}vw)`;
      };
      container.onclick = (e) => {
        if(currentReadMode !== 'page') return;
        if(e.clientX > window.innerWidth * 0.65 && currentPageIndex < totalPages - 1) currentPageIndex++;
        else if(e.clientX < window.innerWidth * 0.35 && currentPageIndex > 0) currentPageIndex--;
        container.style.transition = 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)';
        container.style.transform = `translateX(-${currentPageIndex * 100}vw)`;
      };
  }

  window.closeReadingLobby = () => { 
    if(document.fullscreenElement) document.exitFullscreen();
    localStorage.removeItem('currentReadChapterIdx'); 
    navigateTo('detailPage'); 
  }
  
  window.onclick = (e) => { 
    const sidebar = document.getElementById('readingSettingsSidebar');
    if(sidebar.classList.contains('show') && !sidebar.contains(e.target) && !e.target.closest('.iconBtn')) {
        sidebar.classList.remove('show');
    }
  };

  window.closeDetail = () => { 
    localStorage.removeItem('currentOpenMangaFbId');
    const source = sessionStorage.getItem('active_lobby_source') || 'main';
    navigateTo(source === 'bookmark' ? 'bookmarkPage' : 'mainContentWrapper');
    if(source !== 'bookmark') renderPublic();
  }

  window.toggleBookmark = function(fbId) {
    let b = JSON.parse(localStorage.getItem('bookmarks') || "[]");
    if(b.includes(fbId)) { b = b.filter(id => id !== fbId); showStatus("Removed", "fail"); }
    else { b.push(fbId); showStatus("Added! ‚ù§Ô∏è", "success"); }
    localStorage.setItem('bookmarks', JSON.stringify(b)); openManga(fbId); renderBookmarks();
  }
  
  window.openBookmarkLobby = function() { 
    document.getElementById('adminSidebar').classList.remove('show'); 
    navigateTo('bookmarkPage'); 
    renderBookmarks(); 
  }
  
  window.closeBookmarkLobby = function() { navigateTo('mainContentWrapper'); }

  function renderBookmarks() {
    const b = JSON.parse(localStorage.getItem('bookmarks') || "[]");
    const container = document.getElementById('bookmarkList');
    if(b.length === 0) { container.innerHTML = "<p style='grid-column: 1/-1; text-align:center; opacity:0.4; padding:50px;'>No bookmarks yet.</p>"; return; }
    container.innerHTML = window.mangas.filter(m => b.includes(m.fbId)).map(m => `
        <div class="manga" onclick="openManga('${m.fbId}')">
            ${shouldShowNewBadge(m) ? '<div class="new-chapter-badge">New Chapter Update</div>' : ''}
            ${isNewCover(m) ? '<div class="premium-cover-badge">New</div>' : ''}
            <img src="${m.img}" loading="lazy"><p>${m.name}</p>
        </div>`).join('');
  }
</script>
</body>
</html>

